import openai
import time
import random
# è·å–å½“å‰è„šæœ¬çš„çˆ¶ç›®å½•ï¼ˆå³é¡¹ç›®æ ¹ç›®å½•ï¼‰
import sys
import os
from tot.tasks import get_task
# æ›¿æ¢ä¸ºä½ çš„ OpenAI API Key
openai.api_key = "sk-3N7pMMZwWkqu1HyZgEr8AoM0EM8l5mvNx1TPnwY1edOTtFPJ"

# æ›¿æ¢ä¸º Qwen3 çš„ API ç«¯ç‚¹ï¼ˆå‡è®¾ï¼‰
openai.api_base = "https://api.bianxie.ai/v1"

evaluate_form = """
3. è¯„åˆ†æ ‡å‡†ï¼š
# è¯„åˆ† 20åˆ†ï¼šå·²ç»æ¨å¯¼å‡ºäº†24
input:[24],output:20  # å·²æˆåŠŸï¼Œå½’ä¸º 20 åˆ†

# è¯„åˆ† 19~16ï¼šè¾“å…¥æ•°å­—å¯é€šè¿‡ç®€å•åŠ å‡å¾—åˆ° 24,æ ¹æ®å¤æ‚åº¦è¯„å®š16~19
input:[10,14],output:18  # 10+14=24ï¼Œå½’ä¸º 19~16 åˆ†
input:[9,6,9],output:16  # 9+6+9=24ï¼Œå½’ä¸º 19~16 åˆ†
input:[15,9],output:19  # 15+9=24ï¼Œå½’ä¸º 19~16 åˆ†

# è¯„åˆ† 15~12ï¼šéœ€è¦ä¹˜é™¤åŠ å‡æ‰å¯å¾—åˆ°24,æ ¹æ®å¤æ‚åº¦è¯„å®š16~19
input:[6,4], output:15  # 6 Ã— 4 =24ï¼Œå½’ä¸º 15~12 åˆ†
input:[12,2],output:15  # 12 Ã— 2=24ï¼Œå½’ä¸º 15~12 åˆ†

# è¯„åˆ† 11~8ï¼šéœ€è¦å¤æ‚æ“ä½œ,å³åŠ å‡ä¹˜é™¤å’Œæ‹¬å·éƒ½è¦ç”¨ä¸Šï¼Œæ‰èƒ½å¾—åˆ°24ï¼Œæ ¹æ®å¤æ‚åº¦è¯„å®š11~8
input:[3ï¼Œ3ï¼Œ7ï¼Œ7],output:8 # éœ€è¦å¤æ‚æ“ä½œï¼Œå½’ä¸º 11~8 åˆ† (7 Ã— (3 + 3/7))

# è¯„åˆ† 7~2ï¼šæ— æ³•å¿«é€Ÿæ¨å¯¼,æ ¹æ®æ¨ç†æ½œåŠ›ï¼Œè¯„å®š7~2
input:[6, 7, 9],output:5 #  æ— æ³•å¿«é€Ÿæ¨å¯¼, å½’ä¸º2åˆ†
input:[4, 7, 11],output:2  # æ— æ³•å¿«é€Ÿæ¨å¯¼, å½’ä¸º2åˆ†
# è¯„åˆ† 1ï¼šæ— æ³•æ¨å¯¼å‡º 24
input:[1,1,1,1],output:1 # æ— æ³•æ¨å¯¼å‡º24
input:[2,2,2,2])", 1
"""

def generate_dataset(num_samples=10, output_file="24_dataset_patt2_4.txt"):
    dataset = []
    task = get_task("game24")
    print(f"ğŸ¯ å¼€å§‹ç”Ÿæˆ {num_samples} ä¸ªæ ·æœ¬...")

    for i in range(num_samples):
        # æ„é€ æç¤ºè¯ï¼ˆpromptï¼‰å¼•å¯¼æ¨¡å‹ç”Ÿæˆç¬¦åˆè¦æ±‚çš„æ ·æœ¬
        prompt = ("""
ä½ æ˜¯ä¸€ä¸ª24ç‚¹æ¸¸æˆä¸“å®¶ï¼Œè¯·ç”Ÿæˆinput:è¾“å…¥å’Œå¯¹åº”çš„output:è¯„åˆ†ã€‚
è­¬å¦‚ åˆå§‹24ç‚¹è¾“å…¥ä¸ºå››ä¸ªæ•°ï¼š4 5 6 7
ä¸­é—´çŠ¶æ€ä¸ºï¼š
4x5=20,left: [20,5,7]
20-5=15,left: [15,7]
15+7=22,left: [22]
è¿™å°±æ˜¯ä¸€æ¬¡æ¨ç†ï¼Œç°åœ¨éœ€è¦ä½ å¯¹å¯èƒ½å‡ºç°çš„leftï¼Œè¿›è¡Œè¯„åˆ†
!!!!æ³¨æ„ ä½ æ‰€æœ‰çš„input å¿…é¡»èƒ½é€šè¿‡åŸå§‹24ç‚¹å˜åŒ–å¾—åˆ°!!!!
è¦æ±‚ï¼š
1. ç”Ÿæˆinput,inputä¸ºä¸­é—´çŠ¶æ€é›†åˆï¼Œoutputä¸ºå¾—åˆ†
2. è¯„åˆ†èŒƒå›´ä¸º1-20ï¼Œè¯„åˆ†è§„åˆ™å¦‚ä¸‹ï¼š
   - 20åˆ†ï¼šç›´æ¥å¾—åˆ°24
   - 19-16åˆ†ï¼šå‰©ä½™æ•°å­—å¯é€šè¿‡ç®€å•åŠ å‡å¾—åˆ°24
   - 15-12åˆ†ï¼šéœ€è¦ä¹˜é™¤æˆ–æ‹¬å·
   - 11-8åˆ†ï¼šéœ€è¦å¤æ‚æ“ä½œï¼ˆåµŒå¥—æ‹¬å·ï¼‰
   - 7-2åˆ†ï¼šæ— æ³•å¿«é€Ÿæ¨å¯¼
   - 1åˆ†ï¼šæ— æ³•æ¨å¯¼å‡º24

è¯·ç”Ÿæˆç¬¦åˆè¦æ±‚çš„æ ·æœ¬æ³¨æ„ ä½ çš„è¾“å‡ºä¸ºjsonæ ¼å¼,æ³¨æ„ ä½ çš„è¾“å‡ºä¸€å®šä¸èƒ½å’Œç¤ºä¾‹æœ‰ä»»ä½•ç›¸åŒ,ä½ ç”Ÿæˆçš„inputåº”å°½é‡åœ¨æ¯ä¸ªåˆ†æ®µæ¶µç›–3ï¼Œ2ä¸ªinputè¾“å…¥"""+
"\næœ¬æ¬¡åŸå§‹çš„24ç‚¹æ¸¸æˆè¾“å…¥æ˜¯"+task.get_input(i+800)+
""","!!!!æ³¨æ„,ä½ éœ€è¦å…ˆè¿›è¡Œ24ç‚¹æ¸¸æˆæ¨ç† ç”Ÿæˆä¸€å †ä¸­é—´inputæ­¥éª¤,æ³¨æ„æ¯ä¸ªæ•°å­—åªèƒ½ç”¨ä¸€æ¬¡ï¼Œå¦‚4 5 6 7 å¯ç”Ÿæˆä¸­é—´æ­¥éª¤ 20ï¼ˆå³4Ã—5ï¼‰ 6 7ï¼Œä¹‹åæ¨ç†24ç‚¹çš„æ•°å­—å°±å˜æˆ20 6 7äº† ä½ æ‰€æœ‰çš„input å¿…é¡»èƒ½é€šè¿‡åŸå§‹24ç‚¹åŠ å‡ä¹˜é™¤ç­‰å˜åŒ–å¾—åˆ°!!!!"\n
ç„¶åå†å¯¹ä¸­é—´æ­¥éª¤è¿›è¡Œè¯„åˆ†ï¼Œä½ çš„è¯„åˆ†ä¸ç”¨è¦†ç›–å…¨éƒ¨1-20 åªæ˜¯æ ¹æ®ç”Ÿæˆçš„inputä¸­é—´æ­¥éª¤å®äº‹æ±‚æ˜¯å³å¯ï¼Œä½ çš„è¾“å‡ºæ ¼å¼ä¼šè¢«è§£æä¸ºjsonlï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ— å…³è¾“å‡ºï¼ï¼ï¼:
{"output": 15, "input": [12,2],"reason":"éœ€è¦ä¹˜é™¤åŠ å‡æ‰å¯å¾—åˆ°24,åªéœ€ä¸€æ¬¡ä¹˜æ³•"},
{},
{}
""")

        try:
            # è°ƒç”¨ OpenAI API
            response = openai.ChatCompletion.create(
                model="gpt-4o-all",  # æ›¿æ¢ä¸ºå®é™…æ¨¡å‹åç§°
                messages=[
                    {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ª24ç‚¹æ¸¸æˆä¸“å®¶ï¼Œæ“…é•¿ç”Ÿæˆä¸­é—´çŠ¶æ€å’Œè¯„åˆ†ã€‚"},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.8,  # æ§åˆ¶è¾“å‡ºå¤šæ ·æ€§
                max_tokens=3000,
                request_timeout=10000
            )

            # æå–æ¨¡å‹è¾“å‡º
            generated_text = response.choices[0].message.content.strip()
            dataset.append(generated_text)

            print(f"[{i + 1}/{num_samples}] ç”ŸæˆæˆåŠŸ: {generated_text}")
            time.sleep(0.5)  # é¿å…é¢‘ç¹è¯·æ±‚

        except Exception as e:
            print(f"è¯·æ±‚å¤±è´¥: {e}")
            continue
    # ä¿å­˜åˆ°æ–‡ä»¶
            # æ¯ 5 ä¸ªæ ·æœ¬ä¿å­˜ä¸€æ¬¡
        if (i + 1) % 5 == 0 or (i + 1) == num_samples:
            with open(output_file, "a", encoding="utf-8") as f:
                for line in dataset:
                    f.write(line + "\n")
            print(f"ğŸ’¾ å·²ä¿å­˜å‰ {i + 1} ä¸ªæ ·æœ¬åˆ° {output_file}")
            dataset.clear()  # æ¸…ç©ºç¼“å­˜


    print(f"æ•°æ®é›†å·²ä¿å­˜åˆ° {output_file}")


# è°ƒç”¨å‡½æ•°ç”Ÿæˆæ•°æ®é›†
generate_dataset(num_samples=100)